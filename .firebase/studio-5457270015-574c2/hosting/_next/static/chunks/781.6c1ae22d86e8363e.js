"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[781],{59781:(e,s,a)=>{a.r(s),a.d(s,{default:()=>S});var t=a(95155),l=a(12115),r=a(30285),d=a(18046),i=a(75074),n=a(17607),c=a(18763),o=a(77223),h=a(66695),m=a(90010),u=a(55594),x=a(62177),f=a(90221),j=a(54165),p=a(17759),N=a(62523);let g=u.z.object({name:u.z.string().min(2,{message:"שם הכיתה חייב להכיל לפחות 2 תווים."})});function y(e){let{isOpen:s,onOpenChange:a,onAddClass:d}=e,i=(0,x.mN)({resolver:(0,f.u)(g),defaultValues:{name:""}});return(0,l.useEffect)(()=>{s&&i.reset()},[s,i]),(0,t.jsx)(j.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(j.Cf,{className:"sm:max-w-md",children:[(0,t.jsxs)(j.c7,{children:[(0,t.jsx)(j.L3,{children:"יצירת כיתה חדשה"}),(0,t.jsx)(j.rr,{children:"הזן את שם הכיתה החדשה."})]}),(0,t.jsx)(p.lV,{...i,children:(0,t.jsxs)("form",{onSubmit:i.handleSubmit(e=>{d(e.name),a(!1)}),className:"space-y-4 py-4",children:[(0,t.jsx)(p.zB,{control:i.control,name:"name",render:e=>{let{field:s}=e;return(0,t.jsxs)(p.eI,{children:[(0,t.jsx)(p.lR,{children:"שם הכיתה"}),(0,t.jsx)(p.MJ,{children:(0,t.jsx)(N.p,{placeholder:"למשל, כיתה י'2",...s})}),(0,t.jsx)(p.C5,{})]})}}),(0,t.jsx)(j.Es,{children:(0,t.jsx)(r.$,{type:"submit",children:"שמור"})})]})})]})})}var w=a(73028),v=a(19599),b=a(35317),A=a(23769),C=a(97714),E=a(40610),O=a(3310),I=a(50172),k=a(91950);function S(e){let{}=e,{user:s}=(0,v.useUser)(),a=(0,v.useFirestore)(),[u,x]=(0,l.useState)(!1),[f,j]=(0,l.useState)(null),[p,g]=(0,l.useState)(null),[S,R]=(0,l.useState)(""),J=(0,v.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"classes"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:$,isLoading:z}=(0,A.G)(J),L=$||[],Z=(0,v.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"teachers"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:M}=(0,A.G)(Z),_=M||[],B=(0,v.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"settings"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:H}=(0,A.G)(B),P=(0,l.useMemo)(()=>{if(H){let e=H.find(e=>e.id==="timetable_".concat(null==s?void 0:s.uid));if(e)return e.slots||[]}return[]},[H,s]),D=async e=>{if(!a||!s)return;let t=(0,b.H9)((0,b.rJ)(a,"classes")),l={name:e,schedule:{},userId:s.uid},r=(0,b.wP)(a);r.set(t,{...l,id:t.id}),await (0,C.j)(r,{operation:"create",path:t.path,data:{...l,id:t.id}})},F=async e=>{if(!a||!s)return;let t=(0,b.wP)(a);try{let s=(0,b.H9)(a,"classes",e),l=await (0,b.x7)(s);if(!l.exists())return;let r=l.data(),d=new Set;for(let s of(Object.values(r.schedule||{}).forEach(e=>{Object.values(e).forEach(e=>{Array.isArray(e)&&e.forEach(e=>{e&&!e.majorId&&d.add(e.teacherId)})})}),d)){let l=(0,b.H9)(a,"teachers",s),r=await (0,b.x7)(l);if(r.exists()){let s=r.data(),a=JSON.parse(JSON.stringify(s.schedule||{}));Object.keys(a).forEach(s=>{Object.keys(a[s]||{}).forEach(t=>{let l=a[s][t];Array.isArray(l)&&(a[s][t]=l.filter(s=>s.classId!==e||s.majorId),0===a[s][t].length&&delete a[s][t])}),0===Object.keys(a[s]).length&&delete a[s]}),t.update(l,{schedule:a})}}t.delete(s),await (0,C.j)(t,{operation:"delete",path:"classes/".concat(e," and related teachers")})}catch(s){if(!(s instanceof E.$)){let s=new E.$({operation:"delete",path:"classes/".concat(e," and related teachers")});throw O.d.emit("permission-error",s),s}throw s}},G=async(e,t)=>{if(!a||!s)return;let l=(0,b.wP)(a);try{let s=(0,b.H9)(a,"classes",e),r=await (0,b.x7)(s);if(!r.exists())return;let d=r.data().schedule||{};l.update(s,{schedule:t});let i=new Set;for(let e of[d,t])Object.values(e||{}).forEach(e=>Object.values(e||{}).forEach(e=>{Array.isArray(e)&&e.forEach(e=>{(null==e?void 0:e.teacherId)&&!e.majorId&&i.add(e.teacherId)})}));for(let s of i){let r=(0,b.H9)(a,"teachers",s),i=await (0,b.x7)(r);if(!i.exists())continue;let n=i.data(),c=JSON.parse(JSON.stringify(n.schedule||{}));k.B.forEach(a=>{(P||[]).forEach(l=>{var r,i,n;let o=l.start,h=(null==(r=d[a])?void 0:r[o])||[],m=(null==(i=t[a])?void 0:i[o])||[],u=Array.isArray(h)?h.filter(e=>!e.majorId):[],x=Array.isArray(m)?m.filter(e=>!e.majorId):[],f=u.find(e=>e.teacherId===s),j=x.find(e=>e.teacherId===s);if(f&&!j){let s=(null==(n=c[a])?void 0:n[o])||[];Array.isArray(s)&&(c[a][o]=s.filter(s=>s.classId!==e),0===c[a][o].length&&delete c[a][o])}if(j){c[a]=c[a]||{};let s=c[a][o]||[],t=Array.isArray(s)?s.filter(s=>s.classId!==e):[];c[a][o]=[...t,{...j,classId:e}]}})}),l.update(r,{schedule:c})}await (0,C.j)(l,{operation:"update",path:"classes/".concat(e),data:{schedule:t}}),g(null)}catch(s){if(!(s instanceof E.$)){let s=new E.$({operation:"update",path:"classes/".concat(e),requestResourceData:{schedule:t}});throw O.d.emit("permission-error",s),s}throw s}},T=(L||[]).filter(e=>e.name.toLowerCase().includes(S.toLowerCase()));return z?(0,t.jsx)("div",{className:"p-4 flex justify-center",children:(0,t.jsx)(I.A,{className:"h-8 w-8 animate-spin text-primary"})}):(0,t.jsxs)(h.Zp,{className:"mt-6 border-none shadow-none",children:[(0,t.jsx)(h.aR,{children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(h.ZB,{className:"text-xl",children:"כיתות לימוד"}),(0,t.jsx)(h.BT,{children:"ניהול מערכת השעות הכיתתית."})]}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[(0,t.jsxs)(r.$,{onClick:()=>x(!0),className:"shrink-0",children:[(0,t.jsx)(d.A,{className:"ml-2 h-4 w-4"}),"הוסף כיתה"]}),(0,t.jsxs)("div",{className:"relative flex-grow",children:[(0,t.jsx)(i.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(N.p,{type:"search",placeholder:"חיפוש כיתה...",className:"w-full pl-9",value:S,onChange:e=>R(e.target.value)})]})]})]})}),(0,t.jsx)(h.Wu,{children:L&&L.length>0?T.length>0?(0,t.jsx)("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:T.map(e=>(0,t.jsxs)(h.Zp,{className:"transition-all hover:shadow-md",children:[(0,t.jsxs)(h.aR,{children:[(0,t.jsx)(h.ZB,{children:e.name}),(0,t.jsx)(h.BT,{children:"לחץ לצפייה או עריכת מערכת השעות."})]}),(0,t.jsxs)(h.wL,{className:"grid grid-cols-3 gap-2",children:[(0,t.jsxs)(r.$,{variant:"outline",size:"sm",onClick:()=>j(e),children:[(0,t.jsx)(n.A,{className:"ml-1 h-4 w-4"}),"צפה"]}),(0,t.jsxs)(r.$,{variant:"secondary",size:"sm",onClick:()=>g(e),children:[(0,t.jsx)(c.A,{className:"ml-1 h-4 w-4"}),"ערוך"]}),(0,t.jsxs)(m.Lt,{children:[(0,t.jsx)(m.tv,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"destructive",size:"sm",children:[(0,t.jsx)(o.A,{className:"ml-1 h-4 w-4"}),"מחק"]})}),(0,t.jsxs)(m.EO,{children:[(0,t.jsxs)(m.wd,{children:[(0,t.jsx)(m.r7,{children:"האם אתה בטוח?"}),(0,t.jsx)(m.$v,{children:"פעולה זו תמחק את הכיתה ואת כל השיבוצים המשוייכים אליה ממערכות המורים לצמיתות. לא ניתן לבטל את הפעולה."})]}),(0,t.jsxs)(m.ck,{children:[(0,t.jsx)(m.Zr,{children:"ביטול"}),(0,t.jsx)(m.Rx,{className:(0,r.r)({variant:"destructive"}),onClick:()=>F(e.id),children:"מחק"})]})]})]})]})]},e.id))}):(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-border p-12 text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"לא נמצאו כיתות תואמות"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"נסה מונח חיפוש אחר."})]}):(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-border p-12 text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"לא נמצאו כיתות"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"התחל על ידי יצירת כיתה חדשה."})]})}),(0,t.jsx)(y,{isOpen:u,onOpenChange:x,onAddClass:D}),(0,t.jsx)(w.default,{isOpen:!!f,onOpenChange:e=>!e&&j(null),schoolClass:f,allTeachers:_,isEditing:!1,allClasses:L,timeSlots:P}),(0,t.jsx)(w.default,{isOpen:!!p,onOpenChange:e=>!e&&g(null),schoolClass:p,allTeachers:_,onUpdateSchedule:G,isEditing:!0,allClasses:L,timeSlots:P})]})}},90010:(e,s,a)=>{a.d(s,{$v:()=>j,EO:()=>m,Lt:()=>n,Rx:()=>p,Zr:()=>N,ck:()=>x,r7:()=>f,tv:()=>c,wd:()=>u});var t=a(95155),l=a(12115),r=a(62278),d=a(59434),i=a(30285);let n=r.bL,c=r.l9,o=r.ZL,h=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.hJ,{className:(0,d.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...l,ref:s})});h.displayName=r.hJ.displayName;let m=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsxs)(o,{children:[(0,t.jsx)(h,{}),(0,t.jsx)(r.UC,{ref:s,className:(0,d.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...l})]})});m.displayName=r.UC.displayName;let u=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,d.cn)("flex flex-col space-y-2 text-center sm:text-right",s),...a})};u.displayName="AlertDialogHeader";let x=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,d.cn)("flex flex-col-reverse sm:flex-row sm:justify-start sm:gap-2",s),...a})};x.displayName="AlertDialogFooter";let f=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.hE,{ref:s,className:(0,d.cn)("text-lg font-semibold",a),...l})});f.displayName=r.hE.displayName;let j=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.VY,{ref:s,className:(0,d.cn)("text-sm text-muted-foreground",a),...l})});j.displayName=r.VY.displayName;let p=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.rc,{ref:s,className:(0,d.cn)((0,i.r)(),a),...l})});p.displayName=r.rc.displayName;let N=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.ZD,{ref:s,className:(0,d.cn)((0,i.r)({variant:"outline"}),"mt-2 sm:mt-0",a),...l})});N.displayName=r.ZD.displayName}}]);