"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[32],{16032:(e,s,t)=>{t.r(s),t.d(s,{default:()=>E});var a=t(95155),l=t(12115),n=t(66695),r=t(26126),i=t(66424),c=t(91950),d=t(59434),o=t(86578),m=t(63920),x=t(57804);let h=(0,t(40157).A)("House",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]]);var u=t(79233),f=t(80644),p=t(70831),j=t(76959),b=t(83013),v=t(19599),g=t(35317),N=t(23769),y=t(50172),w=t(30285),k=t(97714),C=t(54165),I=t(30356),M=t(85057);let _=e=>{let{isOpen:s,onOpenChange:t,substitute:n,lessonsToCover:r,onConfirm:i}=e,[c,d]=(0,l.useState)(null),[o,m]=(0,l.useState)(!1);if((0,l.useEffect)(()=>{s&&(d(null),m(!1))},[s]),!n)return null;let x=async()=>{if(!c)return;let e=r.find(e=>"".concat(e.schoolClass.id,"-").concat(e.lesson.subject,"-").concat(e.time)===c);e&&(m(!0),await i(n,e),m(!1),t(!1))};return(0,a.jsx)(C.lG,{open:s,onOpenChange:t,children:(0,a.jsxs)(C.Cf,{children:[(0,a.jsxs)(C.c7,{children:[(0,a.jsx)(C.L3,{children:"שיבוץ מורה מחליף"}),(0,a.jsx)(C.rr,{children:r.length>0?"שבץ את ".concat(n.name," להחליף באחד מהשיעורים הבאים."):"לא נמצאו שיעורים הדורשים החלפה כעת."})]}),r.length>0&&(0,a.jsx)("div",{className:"py-4",children:(0,a.jsx)(I.z,{onValueChange:d,dir:"rtl",children:r.map((e,s)=>{let t="".concat(e.schoolClass.id,"-").concat(e.lesson.subject,"-").concat(e.time);return(0,a.jsxs)("div",{className:"flex items-center space-x-2 space-x-reverse",children:[(0,a.jsx)(I.C,{value:t,id:t}),(0,a.jsxs)(M.J,{htmlFor:t,className:"flex flex-col cursor-pointer",children:[(0,a.jsxs)("span",{children:[e.schoolClass.name," - ",e.lesson.subject," (",e.time,")"]}),(0,a.jsxs)("span",{className:"text-xs text-muted-foreground",children:["מורה חסר: ",e.absentTeacher.name]})]})]},"".concat(t,"-").concat(s))})})}),(0,a.jsxs)(C.Es,{children:[(0,a.jsx)(C.HM,{asChild:!0,children:(0,a.jsx)(w.$,{variant:"ghost",children:"ביטול"})}),r.length>0?(0,a.jsx)(w.$,{onClick:x,disabled:!c||o,children:o?(0,a.jsx)(y.A,{className:"h-4 w-4 animate-spin"}):"אישור שיבוץ"}):(0,a.jsx)(w.$,{onClick:()=>t(!1),children:"הבנתי"})]})]})})},A=e=>{if(!e||!e.includes(":"))return 0;let[s,t]=e.split(":").map(Number);return s+t/60},T=e=>{let s=(0,u.P)(e);if(6===s)return(0,f.o)((0,p.f)(e,1));let t=e.getDate()-s;return(0,f.o)(new Date(new Date(e).setDate(t)))};function E(e){let{substitutions:s}=e,{user:t}=(0,v.useUser)(),C=(0,v.useFirestore)(),[E,D]=(0,l.useState)({isOpen:!1,substitute:null,lessonsToCover:[]}),[B,S]=(0,l.useState)("in_school"),[z,O]=(0,l.useState)(c.B[new Date().getDay()]||c.B[0]),P=(0,v.useMemoFirebase)(()=>t?(0,g.P)((0,g.rJ)(C,"teachers"),(0,g._M)("userId","==",t.uid)):null,[t,C]),{data:F,isLoading:J}=(0,N.G)(P),G=(0,v.useMemoFirebase)(()=>t?(0,g.P)((0,g.rJ)(C,"classes"),(0,g._M)("userId","==",t.uid)):null,[t,C]),{data:$,isLoading:H}=(0,N.G)(G),L=(0,v.useMemoFirebase)(()=>t?(0,g.P)((0,g.rJ)(C,"settings"),(0,g._M)("userId","==",t.uid)):null,[t,C]),{data:V,isLoading:q}=(0,N.G)(L),U=(0,l.useMemo)(()=>{if(V){let e=V.find(e=>e.id==="timetable_".concat(null==t?void 0:t.uid));if(e)return e.slots||[]}return[]},[V,t]),Z=(0,l.useMemo)(()=>T(new Date),[]),R=(0,l.useMemo)(()=>{let e=new Map;return F&&s&&F.forEach(t=>{(t.absences||[]).forEach(a=>{var l;let n=(0,f.o)(new Date(a.date)),r=c.B[(0,u.P)(n)],i=((0,u.P)(n)-(0,u.P)(Z)+7)%7;if(i<0||i>=c.B.length)return;let d=(null==(l=t.schedule)?void 0:l[r])||{};Object.keys(d).forEach(l=>{let i=d[l],c=Array.isArray(i)?i:i?[i]:[];if(c&&c.length>0){let i=A(l);(a.isAllDay||i>=A(a.startTime)&&i<A(a.endTime))&&c.forEach(a=>{if(!s.some(e=>(0,j.r)((0,f.o)(new Date(e.date)),n)&&e.time===l&&e.classId===a.classId&&e.absentTeacherId===t.id)){let s="".concat(r,"-").concat(l);e.has(s)||e.set(s,[]),e.get(s).push({teacher:t,lesson:a})}})}})})}),e},[F,s,U,Z]),W=(0,l.useMemo)(()=>{let e={};return c.B.forEach(s=>{e[s]={},U.forEach(t=>{"break"!==t.type&&(e[s][t.start]=[])})}),(F||[]).forEach(t=>{c.B.forEach((a,l)=>{let n=(0,p.f)(Z,l),r=(t.absences||[]).filter(e=>(0,j.r)((0,f.o)(new Date(e.date)),n));U.forEach(l=>{if("lesson"===l.type){var i,c,d,o,m,x;let h=A(l.start),u=null==(c=t.schedule)||null==(i=c[a])?void 0:i[l.start],p=Array.isArray(u)?u:u?[u]:[];if(p&&p.length>0)return;let b=!1;if(r.length>0&&(b=r.some(e=>{if(e.isAllDay)return!0;let s=A(e.startTime),t=A(e.endTime);return h>=s&&h<t})),b||(s||[]).some(e=>e.substituteTeacherId===t.id&&(0,j.r)((0,f.o)(new Date(e.date)),n)&&e.time===l.start))return;let v=t.availability.find(e=>e.day===a),g=null==v?void 0:v.slots.some(e=>{let s=A(e.start),t=A(e.end);return h>=s&&h<t});"in_school"===B?g&&(null==(o=e[a])||null==(d=o[l.start])||d.push({name:t.name,id:t.id,isInSchool:!0})):"all_not_teaching"===B&&(null==(x=e[a])||null==(m=x[l.start])||m.push({name:t.name,id:t.id,isInSchool:!!g}))}})})}),e},[F,U,s,B,Z]),X=(e,s,t)=>{let a=c.B.indexOf(s),l=(0,p.f)(Z,a),n=[],r="".concat(s,"-").concat(t);(R.get(r)||[]).forEach(e=>{let{teacher:s,lesson:a}=e;if(a&&a.classId){let e=($||[]).find(e=>e.id===a.classId);e&&n.push({date:l,time:t,absentTeacher:s,lesson:a,schoolClass:e})}});let i=null==F?void 0:F.find(s=>s.id===e.id);i&&D({isOpen:!0,substitute:i,lessonsToCover:n})},K=async(e,s)=>{if(!C||!t)return;let{date:a,time:l,absentTeacher:n,lesson:r,schoolClass:i}=s,c=(0,g.wP)(C),d=(0,g.H9)((0,g.rJ)(C,"substitutions")),o={date:(0,b.GP)(a,"yyyy-MM-dd"),time:l,classId:i.id,className:i.name,absentTeacherId:n.id,absentTeacherName:n.name,substituteTeacherId:e.id,substituteTeacherName:e.name,subject:r.subject,userId:t.uid,createdAt:new Date().toISOString()};c.set(d,{...o,id:d.id}),await (0,k.j)(c,{operation:"create",path:"substitutions/".concat(d.id),data:o})};return J||q||H?(0,a.jsx)("div",{className:"p-4 flex justify-center",children:(0,a.jsx)(y.A,{className:"h-8 w-8 animate-spin text-primary"})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.Zp,{className:"mt-6 border-none shadow-none",children:[(0,a.jsxs)(n.aR,{children:[(0,a.jsx)(n.ZB,{className:"text-xl",children:"זמינות מורים להחלפה"}),(0,a.jsx)(n.BT,{children:"הטבלה מציגה מורים שאינם משובצים לשיעור. לחץ על שם מורה כדי לשבץ אותו כמחליף."}),(0,a.jsx)("div",{className:"mt-4 pt-4 border-t",children:(0,a.jsxs)(I.z,{dir:"rtl",defaultValue:"in_school",className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-6",onValueChange:S,value:B,children:[(0,a.jsx)(M.J,{className:"font-semibold text-sm shrink-0",children:"הצג:"}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 space-x-reverse",children:[(0,a.jsx)(I.C,{value:"in_school",id:"filter-in_school"}),(0,a.jsx)(M.J,{htmlFor:"filter-in_school",className:"font-normal cursor-pointer",children:'פנויים בביה"ס'})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2 space-x-reverse",children:[(0,a.jsx)(I.C,{value:"all_not_teaching",id:"filter-all_not_teaching"}),(0,a.jsx)(M.J,{htmlFor:"filter-all_not_teaching",className:"font-normal cursor-pointer",children:"כלל הלא-מלמדים"})]})]})]})})]}),(0,a.jsxs)(n.Wu,{children:[(0,a.jsxs)(i.F,{className:"w-full whitespace-nowrap rounded-md border hidden md:block",children:[(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-center table-fixed min-w-[900px]",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-muted/40",children:[(0,a.jsx)("th",{className:"sticky left-0 top-0 bg-muted/40 p-2 w-40 z-20",children:"שעה"}),c.B.map((e,s)=>{let t=(0,p.f)(Z,s);return(0,a.jsxs)("th",{className:"sticky top-0 bg-muted/40 p-2 min-w-[150px]",children:[(0,a.jsx)("div",{children:e}),(0,a.jsx)("div",{className:"font-normal text-xs text-muted-foreground",children:(0,b.GP)(t,"dd/MM")})]},e)})]})}),(0,a.jsx)("tbody",{children:U.map(e=>(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsxs)("td",{className:"sticky left-0 font-semibold bg-card p-2 w-40 z-10 text-center",children:[(0,a.jsxs)("div",{children:[e.start," - ",e.end]}),"break"===e.type&&(0,a.jsx)(r.E,{variant:"outline",className:"mt-1",children:"הפסקה"})]}),c.B.map(t=>{var l;let n=(null==(l=W[t])?void 0:l[e.start])||[],i=c.B.indexOf(t),u=(0,p.f)(Z,i),b=(s||[]).filter(s=>(0,j.r)((0,f.o)(new Date(s.date)),u)&&s.time===e.start),v=R.get("".concat(t,"-").concat(e.start)),g=null==v?void 0:v.filter(e=>!b.some(s=>s.absentTeacherId===e.teacher.id&&s.classId===e.lesson.classId));return(0,a.jsx)("td",{className:(0,d.cn)("p-2 align-top h-24 border-r","break"===e.type&&"bg-muted/30"),children:"break"===e.type?(0,a.jsx)(o.A,{className:"w-5 h-5 mx-auto text-muted-foreground"}):(0,a.jsxs)("div",{className:"flex flex-col items-stretch gap-1.5 justify-start h-full",children:[g&&g.map((e,s)=>{let{teacher:t,lesson:l}=e;return(0,a.jsxs)("div",{className:"text-center p-2 rounded-md bg-destructive/10 text-destructive border border-destructive/20",children:[(0,a.jsxs)("div",{className:"font-bold text-xs flex items-center justify-center gap-1.5",children:[(0,a.jsx)(m.A,{className:"h-3.5 w-3.5"}),"דרוש מחליף"]}),(0,a.jsxs)("div",{className:"text-xs opacity-80",children:["(",t.name,")"]})]},"".concat(t.id,"-").concat(s))}),b.map(e=>(0,a.jsxs)(r.E,{variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 font-normal",children:[(0,a.jsx)(x.A,{className:"h-3 w-3 ml-1"}),e.substituteTeacherName]},e.id)),(0,a.jsx)("div",{className:"flex flex-wrap items-center justify-center gap-1.5 mt-auto",children:n.map(s=>(0,a.jsxs)(w.$,{variant:s.isInSchool?"secondary":"outline",size:"sm",className:"h-auto px-2 py-1 font-normal text-xs",onClick:()=>X(s,t,e.start),children:[!s.isInSchool&&(0,a.jsx)(h,{className:"h-3 w-3 ml-1 text-muted-foreground"}),s.name]},s.id))}),0===n.length&&(!g||0===g.length)&&0===b.length&&(0,a.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,a.jsx)("span",{className:"text-muted-foreground text-xs opacity-70",children:"--"})})]})},"".concat(t,"-").concat(e.start))})]},e.id))})]})}),(0,a.jsx)(i.$,{orientation:"horizontal"})]}),(0,a.jsxs)("div",{className:"md:hidden space-y-4",children:[(0,a.jsx)("div",{className:"flex overflow-x-auto pb-2 gap-2 no-scrollbar -mx-4 px-4",children:c.B.map((e,s)=>{let t=(0,p.f)(Z,s),l=z===e;return(0,a.jsxs)(w.$,{variant:l?"default":"outline",className:(0,d.cn)("flex-shrink-0 flex flex-col items-center h-auto py-2 px-4 min-w-[80px]",l?"border-primary":"border-border"),onClick:()=>O(e),children:[(0,a.jsx)("span",{className:"font-bold",children:e}),(0,a.jsx)("span",{className:"text-xs font-normal opacity-70",children:(0,b.GP)(t,"dd/MM")})]},e)})}),(0,a.jsx)("div",{className:"space-y-4",children:U.map(e=>{var t;let l=(null==(t=W[z])?void 0:t[e.start])||[],n=c.B.indexOf(z),i=(0,p.f)(Z,n),d=(s||[]).filter(s=>(0,j.r)((0,f.o)(new Date(s.date)),i)&&s.time===e.start),u=R.get("".concat(z,"-").concat(e.start)),b=null==u?void 0:u.filter(e=>!d.some(s=>s.absentTeacherId===e.teacher.id&&s.classId===e.lesson.classId));return(0,a.jsxs)("div",{className:"border rounded-lg p-4 bg-card shadow-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,a.jsxs)("span",{className:"font-semibold text-lg",children:[e.start," - ",e.end]}),"break"===e.type&&(0,a.jsx)(r.E,{variant:"outline",children:"הפסקה"})]}),"break"!==e.type&&(0,a.jsxs)("div",{className:"space-y-3",children:[b&&b.length>0&&(0,a.jsx)("div",{className:"space-y-2",children:b.map((e,s)=>{let{teacher:t,lesson:l}=e;return(0,a.jsxs)("div",{className:"flex items-center justify-between p-2 rounded-md bg-destructive/10 text-destructive border border-destructive/20",children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("span",{className:"text-sm font-medium",children:["דרוש מחליף: ",t.name]}),(0,a.jsx)("span",{className:"text-xs opacity-80",children:l.subject})]}),(0,a.jsx)(m.A,{className:"h-4 w-4"})]},"".concat(t.id,"-").concat(s))})}),d.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:d.map(e=>(0,a.jsxs)(r.E,{variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 py-1 px-2",children:[(0,a.jsx)(x.A,{className:"h-3 w-3 ml-1"}),e.substituteTeacherName]},e.id))}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-muted-foreground mb-2",children:"מורים פנויים:"}),l.length>0?(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:l.map(s=>(0,a.jsxs)(w.$,{variant:s.isInSchool?"secondary":"outline",size:"sm",className:"h-auto px-3 py-1.5 text-xs",onClick:()=>X(s,z,e.start),children:[!s.isInSchool&&(0,a.jsx)(h,{className:"h-3 w-3 ml-1 text-muted-foreground"}),s.name]},s.id))}):(0,a.jsx)("span",{className:"text-sm text-muted-foreground italic",children:"אין מורים פנויים"})]})]}),"break"===e.type&&(0,a.jsx)("div",{className:"flex justify-center py-2",children:(0,a.jsx)(o.A,{className:"h-6 w-6 text-muted-foreground opacity-50"})})]},e.id)})})]})]})]}),(0,a.jsx)(_,{isOpen:E.isOpen,onOpenChange:e=>D(s=>({...s,isOpen:e,substitute:e?s.substitute:null,lessonsToCover:e?s.lessonsToCover:[]})),substitute:E.substitute,lessonsToCover:E.lessonsToCover,onConfirm:K})]})}},63920:(e,s,t)=>{t.d(s,{A:()=>a});let a=(0,t(40157).A)("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]])},86578:(e,s,t)=>{t.d(s,{A:()=>a});let a=(0,t(40157).A)("Coffee",[["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M14 2v2",key:"6buw04"}],["path",{d:"M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1",key:"pwadti"}],["path",{d:"M6 2v2",key:"colzsn"}]])}}]);