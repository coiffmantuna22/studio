"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[781],{59781:(e,s,a)=>{a.r(s),a.d(s,{default:()=>R});var t=a(95155),l=a(12115),r=a(30285),d=a(18046),n=a(75074),i=a(17607),c=a(18763),o=a(77223),u=a(66695),h=a(90010),m=a(55594),x=a(62177),f=a(90221),j=a(54165),p=a(17759),N=a(62523);let g=m.z.object({name:m.z.string().min(2,{message:"שם הכיתה חייב להכיל לפחות 2 תווים."})});function w(e){let{isOpen:s,onOpenChange:a,onAddClass:d}=e,n=(0,x.mN)({resolver:(0,f.u)(g),defaultValues:{name:""}});return(0,l.useEffect)(()=>{s&&n.reset()},[s,n]),(0,t.jsx)(j.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(j.Cf,{className:"sm:max-w-md",children:[(0,t.jsxs)(j.c7,{children:[(0,t.jsx)(j.L3,{children:"יצירת כיתה חדשה"}),(0,t.jsx)(j.rr,{children:"הזן את שם הכיתה החדשה."})]}),(0,t.jsx)(p.lV,{...n,children:(0,t.jsxs)("form",{onSubmit:n.handleSubmit(e=>{d(e.name),a(!1)}),className:"space-y-4 py-4",children:[(0,t.jsx)(p.zB,{control:n.control,name:"name",render:e=>{let{field:s}=e;return(0,t.jsxs)(p.eI,{children:[(0,t.jsx)(p.lR,{children:"שם הכיתה"}),(0,t.jsx)(p.MJ,{children:(0,t.jsx)(N.p,{placeholder:"למשל, כיתה י'2",...s})}),(0,t.jsx)(p.C5,{})]})}}),(0,t.jsx)(j.Es,{children:(0,t.jsx)(r.$,{type:"submit",children:"שמור"})})]})})]})})}var v=a(73028),y=a(19599),b=a(35317),C=a(23769),O=a(97714),E=a(40610),k=a(3310),S=a(50172),I=a(91950);function R(e){let{}=e,{user:s}=(0,y.useUser)(),a=(0,y.useFirestore)(),[m,x]=(0,l.useState)(!1),[f,j]=(0,l.useState)(null),[p,g]=(0,l.useState)(null),[R,J]=(0,l.useState)(""),$=(0,y.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"classes"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:z=[],isLoading:A}=(0,C.G)($),L=(0,y.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"teachers"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:Z=[]}=(0,C.G)(L),M=(0,y.useMemoFirebase)(()=>s?(0,b.P)((0,b.rJ)(a,"settings"),(0,b._M)("userId","==",s.uid)):null,[s,a]),{data:_}=(0,C.G)(M),B=(0,l.useMemo)(()=>{if(_){let e=_.find(e=>e.id==="timetable_".concat(null==s?void 0:s.uid));if(e)return e.slots||[]}return[]},[_,s]),H=async e=>{if(!a||!s)return;let t=(0,b.H9)((0,b.rJ)(a,"classes")),l={name:e,schedule:{},userId:s.uid},r=(0,b.wP)(a);r.set(t,{...l,id:t.id}),await (0,O.j)(r,{operation:"create",path:t.path,data:{...l,id:t.id}})},P=async e=>{if(!a||!s)return;let t=(0,b.wP)(a);try{let s=(0,b.H9)(a,"classes",e),l=await (0,b.x7)(s);if(!l.exists())return;let r=l.data(),d=new Set;for(let s of(Object.values(r.schedule||{}).forEach(e=>{Object.values(e).forEach(e=>{e&&d.add(e.teacherId)})}),d)){let l=(0,b.H9)(a,"teachers",s),r=await (0,b.x7)(l);if(r.exists()){let s=r.data(),a=JSON.parse(JSON.stringify(s.schedule||{}));Object.keys(a).forEach(s=>{Object.keys(a[s]||{}).forEach(t=>{var l;(null==(l=a[s][t])?void 0:l.classId)===e&&delete a[s][t]})}),t.update(l,{schedule:a})}}t.delete(s),await (0,O.j)(t,{operation:"delete",path:"classes/".concat(e," and related teachers")})}catch(s){if(!(s instanceof E.$)){let s=new E.$({operation:"delete",path:"classes/".concat(e," and related teachers")});throw k.d.emit("permission-error",s),s}throw s}},D=async(e,t)=>{if(!a||!s)return;let l=(0,b.wP)(a);try{let s=(0,b.H9)(a,"classes",e),r=await (0,b.x7)(s);if(!r.exists())return;let d=r.data().schedule||{};l.update(s,{schedule:t});let n=new Set;for(let e of[d,t])Object.values(e||{}).forEach(e=>Object.values(e||{}).forEach(e=>(null==e?void 0:e.teacherId)&&n.add(e.teacherId)));for(let s of n){let r=(0,b.H9)(a,"teachers",s),n=await (0,b.x7)(r);if(!n.exists())continue;let i=n.data(),c=JSON.parse(JSON.stringify(i.schedule||{}));I.B.forEach(a=>{(B||[]).forEach(l=>{var r,n,i,o;let u=l.start,h=null==(r=d[a])?void 0:r[u],m=null==(n=t[a])?void 0:n[u];(null==h?void 0:h.teacherId)!==s||m&&m.teacherId===s||(null==(o=c[a])||null==(i=o[u])?void 0:i.classId)===e&&(c[a][u]=null),(null==m?void 0:m.teacherId)===s&&(c[a]=c[a]||{},c[a][u]={...m,classId:e})})}),l.update(r,{schedule:c})}await (0,O.j)(l,{operation:"update",path:"classes/".concat(e),data:{schedule:t}}),g(null)}catch(s){if(!(s instanceof E.$)){let s=new E.$({operation:"update",path:"classes/".concat(e),requestResourceData:{schedule:t}});throw k.d.emit("permission-error",s),s}throw s}},F=(z||[]).filter(e=>e.name.toLowerCase().includes(R.toLowerCase()));return A?(0,t.jsx)("div",{className:"p-4 flex justify-center",children:(0,t.jsx)(S.A,{className:"h-8 w-8 animate-spin text-primary"})}):(0,t.jsxs)(u.Zp,{className:"mt-6 border-none shadow-none",children:[(0,t.jsx)(u.aR,{children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(u.ZB,{className:"text-xl",children:"כיתות לימוד"}),(0,t.jsx)(u.BT,{children:"ניהול מערכת השעות הכיתתית."})]}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[(0,t.jsxs)(r.$,{onClick:()=>x(!0),className:"shrink-0",children:[(0,t.jsx)(d.A,{className:"ml-2 h-4 w-4"}),"הוסף כיתה"]}),(0,t.jsxs)("div",{className:"relative flex-grow",children:[(0,t.jsx)(n.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(N.p,{type:"search",placeholder:"חיפוש כיתה...",className:"w-full pl-9",value:R,onChange:e=>J(e.target.value)})]})]})]})}),(0,t.jsx)(u.Wu,{children:z&&z.length>0?F.length>0?(0,t.jsx)("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:F.map(e=>(0,t.jsxs)(u.Zp,{className:"transition-all hover:shadow-md",children:[(0,t.jsxs)(u.aR,{children:[(0,t.jsx)(u.ZB,{children:e.name}),(0,t.jsx)(u.BT,{children:"לחץ לצפייה או עריכת מערכת השעות."})]}),(0,t.jsxs)(u.wL,{className:"grid grid-cols-3 gap-2",children:[(0,t.jsxs)(r.$,{variant:"outline",size:"sm",onClick:()=>j(e),children:[(0,t.jsx)(i.A,{className:"ml-1 h-4 w-4"}),"צפה"]}),(0,t.jsxs)(r.$,{variant:"secondary",size:"sm",onClick:()=>g(e),children:[(0,t.jsx)(c.A,{className:"ml-1 h-4 w-4"}),"ערוך"]}),(0,t.jsxs)(h.Lt,{children:[(0,t.jsx)(h.tv,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"destructive",size:"sm",children:[(0,t.jsx)(o.A,{className:"ml-1 h-4 w-4"}),"מחק"]})}),(0,t.jsxs)(h.EO,{children:[(0,t.jsxs)(h.wd,{children:[(0,t.jsx)(h.r7,{children:"האם אתה בטוח?"}),(0,t.jsx)(h.$v,{children:"פעולה זו תמחק את הכיתה ואת כל השיבוצים המשוייכים אליה ממערכות המורים לצמיתות. לא ניתן לבטל את הפעולה."})]}),(0,t.jsxs)(h.ck,{children:[(0,t.jsx)(h.Zr,{children:"ביטול"}),(0,t.jsx)(h.Rx,{variant:"destructive",onClick:()=>P(e.id),children:"מחק"})]})]})]})]})]},e.id))}):(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-border p-12 text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"לא נמצאו כיתות תואמות"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"נסה מונח חיפוש אחר."})]}):(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-border p-12 text-center",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"לא נמצאו כיתות"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"התחל על ידי יצירת כיתה חדשה."})]})}),(0,t.jsx)(w,{isOpen:m,onOpenChange:x,onAddClass:H}),(0,t.jsx)(v.default,{isOpen:!!f,onOpenChange:e=>!e&&j(null),schoolClass:f,allTeachers:Z,isEditing:!1,allClasses:z,timeSlots:B}),(0,t.jsx)(v.default,{isOpen:!!p,onOpenChange:e=>!e&&g(null),schoolClass:p,allTeachers:Z,onUpdateSchedule:D,isEditing:!0,allClasses:z,timeSlots:B})]})}},90010:(e,s,a)=>{a.d(s,{$v:()=>j,EO:()=>h,Lt:()=>i,Rx:()=>p,Zr:()=>N,ck:()=>x,r7:()=>f,tv:()=>c,wd:()=>m});var t=a(95155),l=a(12115),r=a(62278),d=a(59434),n=a(30285);let i=r.bL,c=r.l9,o=r.ZL,u=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.hJ,{className:(0,d.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...l,ref:s})});u.displayName=r.hJ.displayName;let h=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsxs)(o,{children:[(0,t.jsx)(u,{}),(0,t.jsx)(r.UC,{ref:s,className:(0,d.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...l})]})});h.displayName=r.UC.displayName;let m=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,d.cn)("flex flex-col space-y-2 text-center sm:text-right",s),...a})};m.displayName="AlertDialogHeader";let x=e=>{let{className:s,...a}=e;return(0,t.jsx)("div",{className:(0,d.cn)("flex flex-col-reverse sm:flex-row sm:justify-start sm:gap-2",s),...a})};x.displayName="AlertDialogFooter";let f=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.hE,{ref:s,className:(0,d.cn)("text-lg font-semibold",a),...l})});f.displayName=r.hE.displayName;let j=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.VY,{ref:s,className:(0,d.cn)("text-sm text-muted-foreground",a),...l})});j.displayName=r.VY.displayName;let p=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.rc,{ref:s,className:(0,d.cn)((0,n.r)(),a),...l})});p.displayName=r.rc.displayName;let N=l.forwardRef((e,s)=>{let{className:a,...l}=e;return(0,t.jsx)(r.ZD,{ref:s,className:(0,d.cn)((0,n.r)({variant:"outline"}),"mt-2 sm:mt-0",a),...l})});N.displayName=r.ZD.displayName}}]);